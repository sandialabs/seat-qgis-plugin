name: QGIS Plugin CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - tests

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: qgis/qgis:latest
        options: --user root
        ports:
          - 99:99

    steps:
      - name: Checkout qgis-plugin
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
          submodules: true  # Ensure all submodules are fetched

      - name: Verify root directory structure
        run: ls -la

      - name: Fetch hidden directories and verify .docker
        run: |
          git fetch --all
          git reset --hard origin/$(git rev-parse --abbrev-ref HEAD)
          if [ -d ".docker" ]; then
            echo ".docker directory exists"
            ls -la .docker
          else
            echo ".docker directory does not exist"
          fi

      - name: Run QGIS Docker container
        run: |
          docker run -d --name qgis-testing-environment \
          -v ${GITHUB_WORKSPACE}:/tests_directory \
          -e DISPLAY=:99 qgis/qgis:latest tail -f /dev/null

      - name: List root directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory"

      - name: List .docker directory contents inside container
        run: |
          if docker exec qgis-testing-environment sh -c "ls -l /tests_directory/.docker"; then
            echo ".docker directory exists inside the container"
          else
            echo ".docker directory does not exist inside the container"
          fi

      - name: List qgis_resources directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/.docker/qgis_resources"

      - name: List test_runner directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/.docker/qgis_resources/test_runner"

      - name: Sleep for Xvfb
        run: sleep 10

      - name: Create and activate virtual environment, install dependencies
        run: |
          docker exec qgis-testing-environment sh -c "python3 -m venv /tests_directory/venv"
          docker exec qgis-testing-environment sh -c "/tests_directory/venv/bin/pip install -r /tests_directory/tests/requirements.txt"

      - name: Setup QGIS and enable the plugin
        run: |
          docker exec qgis-testing-environment sh -c "sh /tests_directory/.docker/qgis_resources/test_runner/qgis_setup.sh seat"
          docker exec qgis-testing-environment sh -c "rm -f /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
          docker exec qgis-testing-environment sh -c "ln -s /tests_directory /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"

      - name: Run Tests
        run: |
          docker exec qgis-testing-environment sh -c "python3 /tests_directory/tests/test_shear_stress.py"
