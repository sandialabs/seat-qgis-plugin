name: QGIS Plugin CI

on:
  push:
    branches:
      - main
      - tests

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QGIS testing environment
        run: |
          docker run -d --name qgis-testing-environment -v ${GITHUB_WORKSPACE}:/tests_directory -e DISPLAY=:99 qgis/qgis:3.28 tail -f /dev/null
          sleep 20

      - name: Prepare QGIS environment
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /usr/share/qgis/.docker/qgis_resources/test_runner/"
          docker exec qgis-testing-environment sh -c "find / -name qgis_setup.sh"
          docker exec qgis-testing-environment sh -c "sh /usr/share/qgis/.docker/qgis_resources/test_runner/qgis_setup.sh seat"
          docker exec qgis-testing-environment sh -c "rm -f /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
          docker exec qgis-testing-environment sh -c "ln -s /tests_directory /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"

      - name: Run tests
        run: docker exec qgis-testing-environment sh -c "cd /tests_directory && ./run_tests.sh"

      - name: Clean up
        run: |
          docker stop qgis-testing-environment
          docker rm qgis-testing-environment
