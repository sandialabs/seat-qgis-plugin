name: QGIS Plugin CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - tests

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: qgis/qgis:latest
        options: --user root
        ports:
          - 99:99

    steps:
      - name: Checkout qgis-plugin
        uses: actions/checkout@v4

      - name: Run QGIS Docker container
        run: |
          docker run -d --name qgis-testing-environment \
          -v ${GITHUB_WORKSPACE}:/tests_directory \
          -e DISPLAY=:99 qgis/qgis:latest tail -f /dev/null

      - name: Wait for Docker to be ready
        run: |
          until docker exec qgis-testing-environment sh -c "ls /"; do sleep 1; done

      - name: Create environment setup script
        run: |
          echo '#!/bin/bash' > setup_env.sh
          echo 'export QGIS_ROOT=/usr' >> setup_env.sh
          echo 'export PYTHONPATH=$QGIS_ROOT/share/qgis/python:$PYTHONPATH' >> setup_env.sh
          echo 'export PATH=$QGIS_ROOT/bin:$PATH' >> setup_env.sh
          echo 'echo QGIS_ROOT=$QGIS_ROOT' >> setup_env.sh
          echo 'echo PYTHONPATH=$PYTHONPATH' >> setup_env.sh
          echo 'echo PATH=$PATH' >> setup_env.sh
          echo 'which python3' >> setup_env.sh
          chmod +x setup_env.sh
          docker cp setup_env.sh qgis-testing-environment:/setup_env.sh

      - name: Setup QGIS Python environment and verify
        run: |
          docker exec qgis-testing-environment sh -c "/setup_env.sh"

      - name: Install dependencies
        run: |
          docker exec qgis-testing-environment sh -c "/setup_env.sh && pip3 install -r /tests_directory/tests/requirements.txt"

      - name: Setup QGIS and enable the plugin
        run: |
          docker exec qgis-testing-environment sh -c "/setup_env.sh && sh /tests_directory/.docker/qgis_resources/test_runner/qgis_setup.sh seat"
          docker exec qgis-testing-environment sh -c "/setup_env.sh && rm -f /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
          docker exec qgis-testing-environment sh -c "/setup_env.sh && ln -s /tests_directory /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"

      - name: Run Tests
        run: |
          docker exec qgis-testing-environment sh -c "python3 /tests_directory/tests/test_shear_stress.py"

      - name: Clean up Docker container
        if: always()
        run: |
          docker stop qgis-testing-environment
          docker rm qgis-testing-environment
