name: QGIS Plugin CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  test-seat-package:
    runs-on: ubuntu-latest
    services:
      docker:
        image: qgis/qgis:final-3_28_15
        options: --user root
        ports:
          - 99:99

    steps:
      - name: Checkout qgis-plugin
<<<<<<< HEAD
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
          submodules: true  # Ensure all submodules are fetched

      - name: Verify root directory structure
        run: ls -la

      - name: Fetch hidden directories and verify .docker
        run: |
          git fetch --all
          git reset --hard origin/$(git rev-parse --abbrev-ref HEAD)
          if [ -d ".docker" ]; then
            echo ".docker directory exists"
            ls -la .docker
          else
            echo ".docker directory does not exist"
          fi
=======
        uses: actions/checkout@v4
>>>>>>> ab2d4cc1dece490a861369b6ec831ef17c359e49

      - name: Run QGIS Docker container
        run: |
          docker run -d --name qgis-testing-environment \
          -v ${GITHUB_WORKSPACE}:/tests_directory \
          -e DISPLAY=:99 qgis/qgis:final-3_28_15 tail -f /dev/null

      - name: List root directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory"

      - name: List qgis_resources directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/seat"

      - name: List test_runner directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/tests"

      - name: List test_runner directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/."

      - name: List test_runner directory contents inside container
        run: |
          docker exec qgis-testing-environment sh -c "ls -l /tests_directory/.."

      - name: Wait for Docker to be ready
        run: |
          until docker exec qgis-testing-environment sh -c "ls /"; do sleep 1; done

      - name: Install plugin by manually via Copy
        run: |
          docker exec qgis-testing-environment sh -c '
          PLUGIN_SRC_PATH=/tests_directory/seat
          PLUGIN_DEST_DIR=/usr/share/qgis/python/plugins/seat
          mkdir -p $PLUGIN_DEST_DIR
          cp -r $PLUGIN_SRC_PATH/* $PLUGIN_DEST_DIR/
          '

      - name: Install Dependencies
        run: |
          docker exec qgis-testing-environment sh -c "python3 /tests_directory/tests/install_dependencies.py"

      - name: Install Dependencies using apt
        run: |
          docker exec qgis-testing-environment sh -c "apt-get update && apt-get install -y python3-pandas python3-netcdf4 python3-pytest"

      - name: Run Pytest
        run: |
          docker exec qgis-testing-environment pytest /tests_directory/tests

      - name: Clean up Docker container
        if: always()
        run: |
          docker stop qgis-testing-environment
          docker rm qgis-testing-environment
