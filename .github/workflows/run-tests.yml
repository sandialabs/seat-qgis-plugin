name: QGIS Plugin CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  test-seat-package:
    runs-on: ubuntu-latest
    services:
      docker:
        image: qgis/qgis:latest
        options: --user root
        ports:
          - 99:99

    steps:
      - name: Checkout qgis-plugin
        uses: actions/checkout@v4

      - name: Run QGIS Docker container
        run: |
          docker run -d --name qgis-testing-environment \
          -v ${GITHUB_WORKSPACE}:/tests_directory \
          -e DISPLAY=:99 qgis/qgis:latest tail -f /dev/null

      - name: List directory contents for debugging
        run: ls -aR

      # - name: Run QGIS Docker container
      #   run: |
      #     docker run -d --name qgis-testing-environment \
      #     -v ${GITHUB_WORKSPACE}:/tests_directory \
      #     -e DISPLAY=:99 qgis/qgis:latest tail -f /dev/null

      - name: Wait for Docker to be ready
        run: |
          until docker exec qgis-testing-environment sh -c "ls /"; do sleep 1; done

      - name: Locate QGIS executable
        run: |
          docker exec qgis-testing-environment which qgis

      - name: Find QGIS related files
        run: |
          docker exec qgis-testing-environment find / -name "*qgis*" -type f 2>/dev/null

      - name: Find QGIS libraries
        run: |
          docker exec qgis-testing-environment find / -name "*.so*" 2>/dev/null | grep qgis

      - name: Install QGIS Plugin from Zip
        run: |
          # Define plugin path
          PLUGIN_ZIP_PATH=/tests_directory/seat_qgis_plugin.zip
          PLUGIN_DIR=/usr/share/qgis/python/plugins

          # Extract the plugin zip to the QGIS plugin directory
          docker exec qgis-testing-environment unzip $PLUGIN_ZIP_PATH -d $PLUGIN_DIR

      - name: Verify Plugin Installation
        run: |
          docker exec qgis-testing-environment ls /usr/share/qgis/python/plugins

      # - name: Install Dependencies
      #   run: docker exec qgis-testing-environment sh -c "python3 /tests_directory/tests/install_dependencies.py"

      # - name: Setup QGIS and enable the plugin
      #   run: |
      #     docker exec qgis-testing-environment sh -c "qgis_setup.sh seat"
      #     docker exec qgis-testing-environment sh -c "rm -f /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
      #     docker exec qgis-testing-environment sh -c "ln -s /tests_directory /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
      # #docker exec qgis-testing-environment sh -c "ln -s /tests_directory/seat /root/.local/share/QGIS/QGIS3/profiles/default/python/plugins/seat"
      # - name: Run tests
      #   run: |
      #     docker exec qgis-testing-environment sh -c "export PYTHONPATH=/tests_directory:\$PYTHONPATH && qgis_testrunner.sh tests.test_example.run_all"

      - name: Clean up Docker container
        if: always()
        run: |
          docker stop qgis-testing-environment
          docker rm qgis-testing-environment
