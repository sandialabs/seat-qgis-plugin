.. _acoustics_module:

Acoustics Module
----------------

The SEAT acoustics module evaluates the risk associated with sound pressure levels or sound exposure levels generated by MEC arrays. 
The SEAT module uses model results from Paracousti, which is an open-source underwater sound propagation simulator. 
Paracousti simulates sound wave propagation within realistic 3-D earth, atmosphere, and hydroacoustic models, and includes acoustic 
variability within medium density strata due to changes in topography, bathymetry, or voids in the subsurface. 
Paracousti model output are generated for a range of environmental conditions that are each associated with a probability. If the user is interested in a particular species, the paracousti output can be processed through a 
weighted calculation to determine how the sound intensity is modulated for certain species, following equation 1 in `Criteria and Thresholds for US Navy Acoustic and Explosive Effects <https://nwtteis.com/portals/nwtteis/files/technical_reports/Criteria_and_Thresholds_for_U.S._Navy_Acoustic_and_Explosive_Effects_Analysis_June2017.pdf>`_.


The module determines the percentage of time that an acoustics threshold will be exceeded spatially
by combining a probability weighted acoustic field derived from individual Paracousti simulation NetCDF files; 
and a species auditory threshold. 
SEAT can determine the likelihood of a species being impacted by using probability of occurrence or species density maps. 
Additionally, with the inclusion of a Area of Interest, the impacts on specific regions of interest can be evaluated, such as within breeding grounds or in different vegetation.
Two different analyses are carried out for the acoustics calculations: probabilistic and non-probabilistic. 
The probabilistic calculation uses the probabilities file to determine the 24-hour signal for SEL weighted by the probabilities file. 
For SPL, a probability weighted single is calculated.


Input 
^^^^^^
The input for the acoustic stress module is a set of NetCDF files containing data for scenarios with and without devices present from paracousti model output.

These include:

  - NetCDF files: model output with 1) baseline runs; 2) device present runs

  - \*Model Probability Condition file (CSV): Used to weight the likelihood of different run scenarios occurring (i.e., likelihood of environmental conditions)
  
  - \*Area of Interest file (GeoTIFF): Contains spatial classifications, used to evaluate the impact of the devices on the environment
  
  - \*Spatial Probability/Density directory (directory): includes GeoTiffs or CSVs of species, density and corresponds to the probabilities file

  \*Optional input files


Input File Sources
"""""""""""""""""""""
SEAT is designed to read output from the Sandia `paracousti model <https://sandialabs.github.io/Paracousti/>`_.
The user can provide input from alternative sources if the input are formatted correctly. 

The output from the paracousti model can either be weighted or unweighted, depending if the user would like to focus on a specific animal. 
The weighting calculation is based on `Criteria and Thresholds for US Navy Acoustic and Explosive Effects <https://nwtteis.com/portals/nwtteis/files/technical_reports/Criteria_and_Thresholds_for_U.S._Navy_Acoustic_and_Explosive_Effects_Analysis_June2017.pdf>`_.


Default Sources
+++++++++++++++++
The MHkit friendly tools output acoustic data in NetCDF format.  
The NetCDF files contain variables that are based on the receptor input. These variables can include sound pressure level or sound exposure level variables.
The variable name is specified in the receptor file.


Alternative Sources
+++++++++++++++++++++
If the user would like to use a different model, the user must ensure that the input files are formatted correctly within the NetCDF.

Coordinate variable names must be in the variable attributes such that: 

  * ``xcor, ycor = netcdf_dataset.variables[variable].coordinates.split()`` 

The coordinates units attribute must include “degrees” if the coordinates are lat/lon such that:

  * 'degrees’ in ``ds.variables[<xcor variable>].units`` is ``True`` for ``lat/lon``

Weighted and Additional Variables:
++++++++++++++++++++++++++++++++++++
  * Weighted and Unweighted Sound Pressure Level (SPL) and Sound Exposure Level (SEL) variables can be included in the NetCDF file with the format specified in `Paracousti PreProcessing <../seat_qgis_plugin/acoustics/01_paracousti_preprocessing.html>`_.

Output 
""""""

Note that if no baseline model files are provided, the baseline is assumed to be zero.

GeoTIFF raster files: 

  - **paracousti_with_devices.tif**: The probability weighted signal with devices
  - **paracousti_without_devices.tif**: The probability weighted signal without devices (baseline)
  - **paracousti_stressor.tif** : The difference between with devices and baseline models results. 
  - **species_threshold_exceeded.tif** : the percent of time the acoustic threshold was exceeded.
  - **species_percent.tif** : the threshold exceeded and weighted species percent.
  - **species_density.tif** : the threshold exceeded and weighted species density.

CSV files:
Non-probablistic files are appended with the suffix corresponding to the unique Paracousti filename. 
For example, if the filename is Hw0.5.nc, the stressor file will be named paracousti_stressor_Hw0.5.tif

      - **paracousti_stressor.csv**
      - **paracousti_stressor_pacwave_*_*.csv**
      - **paracousti_with_devices.csv**
      - **paracousti_without_devices.csv**
      - **species_threshold_exceeded.csv**
      - **species_percent.csv**
      - **species_density.csv**

Segmented by spatial classification when using the Area of Interest file: 

      - **paracousti_stressor_at_paracousti_area_of_interest.csv**
      - **species_density_at_paracousti_area_of_interest.csv**
      - **species_percent_at_paracousti_area_of_interest.csv**
  


Core Functions 
^^^^^^^^^^^^^^^
+------------------------------------+-----------------------------------------------------------------------+
| Function                           | Description                                                           |
+====================================+=======================================================================+
| ``calculate_acoustic_stressors()`` | Main function that loads data, performs calculations, and computes    |
|                                    | various metrics including acoustic differences and spatial variability|
|                                    | of species auditory thresholds.                                       |
+------------------------------------+-----------------------------------------------------------------------+
| ``run_acoustic_stressor()``        | Creates GeoTIFFs and CSV files to visualize and quantify acoustic     |
|                                    | changes and spatial variability of species auditory thresholds.       |
+------------------------------------+-----------------------------------------------------------------------+
